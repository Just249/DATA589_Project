---
title: "DATA589_Project"
author: "Justin Chan, CM Tong (Kenny)"
date: "2023-04-14"
output:
  pdf_document: default
  html_document: default
---
# Dataset   
URL: https://www.gbif.org/occurrence/download/0165170-230224095556074
Species: Ascomycota

```{r setup, include=FALSE} 
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 
```

# Introduction:   
Provide a brief description of the study system from which the data come and an outline of what questions you intend on exploring with the data, citing any relevant literature. Length: ca. 1 page.

# Methods:   
Briefly describe the data and what variables are included. Provide a detailed description of the analytical workflow that was applied to the data, citing any relevant literature and statistical packages employed. There should be enough information that anyone can reproduce the workflow if they had access to the data. Length: As long as necessary.

```{r}
# install.packages("rgbif")
library(rgbif)
?rgbif

species <- c("Ascomycota")

# Get number of occurrence records from rgbif
#occ_count(scientificName = species) #16069587 in the dataset

#Filter Ascomycota data to only in BC
asc_count <- occ_count(scientificName = species,
                          hasCoordinate = TRUE,
                          country = "CA",
                          stateProvince = "British Columbia")

asc_bc_data <- occ_data(scientificName = species,
                           hasCoordinate = TRUE,
                           country = "CA",
                           stateProvince = "British Columbia") #* 102 illegal points stored in attr(,“rejects”) ***

class(asc_bc_data) #gbif_data 
asc_bc_data <- asc_bc_data$data #gbif_data to data.frame
head(asc_bc_data) #contain "Ascomycota" data only in BC

```

## Data Records

Firstly, screen through some sample records of the dataset to see what information it contains and which attributes would and would not be useful and valuable in our analysis.

```{r}
asc_bc_data <- apply(asc_bc_data,2,as.character)

# check the working directory and ensure that you have write access to that directory
getwd()
#add write acces
# setwd("C:/Users/chanp/Desktop/MDS/Class/Block6/DATA589/Project")

setwd(dirname(rstudioapi::getActiveDocumentContext()$path))
# save the data as CSV
write.csv(asc_bc_data, "data/asc_bc_data.csv", row.names = FALSE)
asc_bc_data <- read.csv("data/asc_bc_data.csv")

head(asc_bc_data)
```

Broadly speaking, from the above records screening, the dataset information can be categorised into the following types according to the dataset attribuets :

- Species Taxonomy Information : There are many information about the species/family/genus/kingdom/class etc which correspond to the structural classification system of the fungi family.
- Collected Record Information : Contains how observation is made (by human?), date, time and location (coordinate, continents, etc) it is collected, the sample collector/institution

## Data Cleaning

As the dataset contains too many information, including many detailed timestamps, key information and dataset/records identifiers which should not be valuable in our analysis and complicate our subsequent analysis, we have performed preliminary cleaning procedure and perform attributes selection, in order to extract those potentially useful attributes and make our analysis more focused.  The cleaned list if shown below.

```{r}

# View(data.frame(names(asc_bc_data)))
cleaned_asc_bc <- asc_bc_data[ , c("decimalLongitude", "decimalLatitude", "order", "family", "genus", "species", "genericName", "specificEpithet", "coordinateUncertaintyInMeters", "stateProvince", 
                                  "year", "month", "day", "eventDate", "occurrenceStatus", "class", "countryCode","country", "verbatimLocality", "taxonID", "catalogNumber", "institutionCode", "eventTime",
                                  "verbatimEventDate", "collectionCode", "gbifID", "verbatimLocality"
                                  )]
```
```{r}
names(cleaned_asc_bc)


```

## Initial Coordinates Plotting

```{r}
# convert cleaned_asc_bc to SpatialPointsDataFrame-class
#reference: https://www.nceas.ucsb.edu/sites/default/files/2020-04/OverviewCoordinateReferenceSystems.pdf
#           https://scisus.org/2014/05/

names(cleaned_asc_bc)
sort(unique(cleaned_asc_bc$individualCount))  # notice if some points correspond to zero abundance
sort(unique(cleaned_asc_bc$occurrenceStatus))  # check for different indications of "absent", which could be in different languages
absence_rows <- which(cleaned_asc_bc$individualCount == 0 | cleaned_asc_bc$occurrenceStatus %in% c("absent", "Absent", "ABSENT", "ausente", "Ausente", "AUSENTE"))
length(absence_rows)
if (length(absence_rows) > 0) {
  cleaned_asc_bc <- cleaned_asc_bc[-absence_rows, ]
}

library(sp)
sp_asc_bc <- SpatialPointsDataFrame(coords = cleaned_asc_bc[, c("decimalLongitude", "decimalLatitude")],
                                         data = cleaned_asc_bc)


proj4string(sp_asc_bc) <- CRS("+proj=longlat +datum=WGS84")

# install.packages("rgdal")
library(rgdal)

#project basemap to match spu shapefile
tran_sp_asc_bc <- spTransform(sp_asc_bc, CRS("+proj=aea +lat_0=45 +lon_0=-126 +lat_1=50 +lat_2=58.5 +x_0=1000000 +y_0=0 +datum=NAD83 +units=m +no_defs")) 
summary(tran_sp_asc_bc)

#update to spTransformed Longitude & Latitude 
cleaned_asc_bc$decimalLongitude <- tran_sp_asc_bc@coords[, 1]
cleaned_asc_bc$decimalLatitude <- tran_sp_asc_bc@coords[, 2]

# save the data as CSV
write.csv(cleaned_asc_bc, "data/clean_sp_asc_bc", row.names = FALSE)
cleaned_asc_bc <- read.csv("data/clean_sp_asc_bc")

#plot(decimalLatitude ~ decimalLongitude,
#     pch = 16,
#     col = "#046C9A",
#     data = cleaned_asc_bc)
```

```{r}
library(spatstat)
# install.packages("maptools")
library(maptools)
#Visualise the data
plot(decimalLatitude ~ decimalLongitude,
     pch = 16,
     col = "#046C9A",
     data = cleaned_asc_bc)

```
From the initial coordinate plot, we have identified the following very preliminary observation :

- Points clustering is highly likely as a large group of data points is spotted at the decimal Longitude between 1000K and 1300K and Latitude between 4e+5 and 5e+5.
- Therefore is only a single major and significant large clustering only.  Although there are some other scattered points observed near the Longitude range 1500K-1800K, they are simply incomparable to the large clustering. 

## BC Windows Data Walkthough

Let's see what the BC_Covariates.Rda file provide us which may help us to identify and choose appropriate fields to be used in the covariates analysis in the later part of this analysis.  It should contain the information on the BC province :

- Windows
- Elevation
- Forest
- Dist Water

```{r}
load("data/BC_Covariates.Rda")

#observe windows
BC<-DATA
BC_win <- DATA$Window
BC_win <- as.owin(DATA$Window)
plot(BC_win,
      pch = 16,
      cols = "red",
      main = "BC windows data")
```

```{r}
#Elevation
plot(BC$Elevation, main = "Elevation")
```
```{r}
#Forest
plot(BC$Forest, main = "Forest")
```

```{r}
#Dist_Water
plot(BC$Dist_Water, main = "Dist_Water")
```

## Spatial Dataset Conversion and Preparation

As the current format of the fungi data is not in a PPP class object, to facilitate subsequent analysis and plots, we would firstly convert it to the PPP, which would make subsequent plotting and analysis library much more accessible. 
```{r}
# names(cleaned_asc_bc$decimalLongitude)
# class(cleaned_asc_bc$decimalLongitude)


# convert into ppp object
asc_data_ppp <- ppp(x = cleaned_asc_bc$decimalLongitude,
                     y = cleaned_asc_bc$decimalLatitude,
                     window = BC_win)

length(asc_data_ppp)

```
```{r}
anyDuplicated(asc_data_ppp)
asc_data_ppp
```


```{r}
# length(cleaned_asc_bc$decimalLongitude)
# length(cleaned_asc_bc$decimalLatitude)
# length(cleaned_asc_bc$species)
# length(marks(asc_data_ppp))
# 
# marks(asc_data_ppp) <- factor(cleaned_asc_bc$species)
# length(cleaned_asc_bc$species)


plot(asc_data_ppp)
# 
# marks(asc_data_ppp) <- BC[[1]]$Region

```
```{r}
plot(BC$Elevation, main = "elevation data")
plot(asc_data_ppp, 
     which.marks = "species", # Which mark to use
     col = "grey", #The colour of the window
     cols = 'red', #The colours of the points
     cex = 0.6,
     pch = 18, # The plotting symbol
     main = "Ascomycota in BC", # The title
     par(bg="grey40", cex.main = 2),
     cex = 0.6,
     legend = T) # Turn of the legend depending on needs`
```


```{r}
col_pal <- rev(rainbow(100,end = 4/6))

fig <- persp(BC$Elevation, # source data
              theta = 10,
              phi = 40, # rotation
              expand = 0, # z-axis expansion
              border = NA, #remove grid borders
              apron = FALSE, #apron around edge
              shade = 0.3, # shading
              box = FALSE, # axes on/off
              main = "BC Parks Elevation", # title
              visible = TRUE, #Supporting calculations
              colmap = col_pal) # colour pallet

perspPoints(asc_data_ppp, Z = BC$Elevation, M = fig, pch = 16, cex = 0.7, col="black")

```
```{r}
plot(cut(BC$Elevation,5,
labels = c("low","low-medium","medium","medium-high","high")),
par(bg="grey40", cex.main = 2),
main = "Elevation classes")

points(asc_data_ppp, pch = 16, cex = 0.35, col="green")

cut <- cut(BC$Elevation,5,
labels = c("low","low-medium","medium","medium-high","high"))
table(cut[asc_data_ppp]) #most in low elevation

```
```{r}
# nn_dist <- nndist(asc_data_ppp)
# marks(asc_data_ppp) <- nn_dist
# plot(asc_data_ppp, main = "Ascomycota Distance",which.marks = "Dist", pch = 16)
BC$Elevation[asc_data_ppp]

library("kdensity")
asc_density <- density(BC$Elevation[asc_data_ppp])
province_density <- density(BC$Elevation$v, na.rm=T)


plot(province_density, main = "KDE of elevation values within province and park locations", xlab = "Elevation", ylab = "Density", col="blue")
lines(asc_density, col = "red")
legend("topright", legend = c("Province", "Parks"), lty = 1, col = c("blue", "red"), bty = "n")

# 
# plot(province_density, main = "KDE of elevation values within province and park locations", xlab = "Elevation", ylab = "Density", col="blue")
# lines(park_density, col = "red")
# legend("topright", legend = c("Province", "Parks"), lty = 1, col = c("blue", "red"), bty = "n")

```


## First Moment Descriptive Statistics
```{r}
intensity(asc_data_ppp)
```

### Homogeneity Studies, Quadrat Test and Hotspot Analysis

Note that the intensity is a very small number.  This is consistent with our plots above.  There are not many points in the whole BC windows.  Overwhelming majority of the points are spresely located in the BC.  Let's verify this with the Quadrat Count Plot.


```{r}
Q <- quadratcount(asc_data_ppp,
                  nx = 4,
                  ny = 4)

#Plot the output 
plot(asc_data_ppp,
     pch = 16,
     cex = 0.5,
     cols = "#046C9A",
     main = " Ascomycota Locations - Quadrat Count")

plot(Q, cex = 2, col = "red", add = T)

```

```{r}
plot(intensity(Q, image = T),
     main = "Ascomycota intensity")

plot(asc_data_ppp,
     pch = 16,
     cex = 0.6,
     cols = "white",
     add = T)

plot(asc_data_ppp,
     pch = 16,
     cex = 0.5,
     cols = "black",
     add = T)
```
```{r}
#Quadrat test of homogeneity 
quadrat.test(Q)
```
```{r}
R <- bw.ppl(asc_data_ppp)
LR <- scanLRTS(asc_data_ppp,r=R)
plot(LR,"Likelihood Ratio Test")
plot(asc_data_ppp$window,add=T)

pvals <- eval.im(pchisq(LR,
                        df = 1,
                        lower.tail = FALSE))


#Plot the output
plot(pvals, main = "Local p-values")
plot(asc_data_ppp$window,add=T)
```


Once again, this has strongly verified the spatial inhomogeneity nature of the fungi distribution :

- About 90% of the regions have zero point.
- Less than 5% of the regions contain more than 85% of all the points
- Quadrat Test also indicates a significant deviation from homogeneity.
- Hot spot analysis shows only a single prominent hot spot

## Covariate Study
### Covariate Variable : Elevation

```{r}
elev <- BC$Elevation
b <- quantile(elev,probs=(0:4)/4,type=2)
Zcut <- cut(elev,breaks=b)
V <- tess(image=Zcut)
quadratcount(asc_data_ppp,tess=V)
```
```{r echo=FALSE}
rho <- rhohat(asc_data_ppp,elev)
plot(rho)
```


### Covariate Variable : Forest

```{r}
forest <- BC$Forest
b <- quantile(forest,probs=(0:4)/4,type=2)
Zcut <- cut(forest,breaks=b)
V <- tess(image=Zcut)
quadratcount(asc_data_ppp,tess=V)
```
```{r echo=FALSE}
rho <- rhohat(asc_data_ppp,forest)
plot(rho)
```



### Covariate Variable : Distance to Water

```{r}
dist <- BC$Dist_Water
b <- quantile(dist,probs=(0:4)/4,type=2)
Zcut <- cut(dist,breaks=b)
V <- tess(image=Zcut)
quadratcount(asc_data_ppp,tess=V)
```

### Covariate Variable Observation

Observation : 

- For Elevation Level :
  - It is obvious that the fungi is overwhelmingly correlated to the low elevation level.  
  - The proportion of occurrence that appears in the lowest elevation sector accounts for more than 97% of the identified points.
- For Forest and Distance to Water :
  - It is observed that the fungi is correlated to both Forest and distance .  
  - The proportion of occurrence that appears in the respective smallest sectors account for about 50% of the identified points.


## Second Moment Descriptives

### Ripley's K-function

```{r}
# Bootstrapped CIs
# rank = 1 means the max and min
# Border correction is to correct for edges around the window
# values will be used for CI
E_asc <- envelope(asc_data_ppp,
                  Kest,
                  correction="border",
                  rank = 1,
                  nsim = 19,
                  fix.n = T)

# visualise the results
plot(E_asc,
     main = "",
     lwd = 2,
     xlim=c(0,120000))

```

Now, we are going to correct for inhomogeneity... 
```{r}
lambda_asc <- density(asc_data_ppp, bw.ppl)
Kinhom_asc <- Kinhom(asc_data_ppp, lambda_asc)

#Estimate a strictly positive density
lambda_asc_pos <- density(asc_data_ppp,
                          sigma=bw.ppl,
                          positive=TRUE)

#Simulation envelope (with points drawn from the estimated intensity)
E_asc_inhom <- envelope(asc_data_ppp,
                        Kinhom,
                        simulate = expression(rpoispp(lambda_asc_pos)),
                        correction="border",
                        rank = 1,
                        nsim = 19,
                        fix.n = TRUE)

# visualise the results
# par(mfrow = c(1,2))
plot(E_asc_inhom,
     main = "Ripley's K-function (Inhomegeneity)",
     lwd = 2,
     xlim=c(0,120000))

```

For homogeneous case, the observed data show a strong clustering at small r value range.  When corrected for inhomogeneity, such clustering pattern is no longer observed.

### Pair Correlation Function
```{r}
# Estimate the g function
pcf_asc <- pcf(asc_data_ppp)

pcf_asc
plot(pcf_asc,xlim=c(0,120000),main="Pair Correlation Function")
```
The above estimator also assumes homogeneity.  Let's relax this assumption.

```{r}
#Simulation envelope (with points drawn from the estimated intensity)
pcf_asc_inhom <- envelope(asc_data_ppp,
                          pcfinhom,
                          simulate = expression(rpoispp(lambda_asc_pos)),
                          rank = 1,
                          nsim = 19)


plot(pcf_asc_inhom,
     xlim = c(0,120000),
     main = "",
     lwd = 2)

```
When corrected for homogeneity, the locations of the fungi appear not to have any significant correlations.


### Model Fitting and Selection with AIC
```{r}
fit <- ppm(asc_data_ppp ~ Elevation + Dist_Water + Forest, data = BC)
fit
```

Elevation and Forest are significant but Dist_Water isn't.  OK, then try higher order.

```{r}
fit <- ppm(asc_data_ppp ~ Elevation + I(Elevation^2) + Dist_Water + I(Dist_Water^2), data = BC)
fit
```
OK, after trying several rounds, the following seems to be a improved fit :
```{r}
fit_simple <- ppm(asc_data_ppp ~ Elevation + Forest, data = BC)
fit_simple
fit <- ppm(asc_data_ppp ~ Elevation + I(Elevation^2) + Forest + I(Forest^2), data = BC)
fit
```
Now, let's see if the complicated model is worth it.
```{r}
#AIC values
AIC(fit); AIC(fit_simple)
#Delta AIC
AIC(fit_simple) - AIC(fit)
```
Also, conduct a anova LRT test to compare the two models :
```{r}
anova(fit_simple, fit, test = "LRT")
```

The following conclusion is drawn :
- The model with quadratic terms provides a better fit to the data
- With the delta AIC of 44, the extra complexity is well supported.
- So, a good model should be 

</br>
<center>
$\lambda_{\mathrm{\textit{ASC}}}(u) = e^{-16.2~-~0.017~\mathrm{elevation}(u)~-~0.000003~\mathrm{elevation}(u)^2~-~0.042~\mathrm{forest}(u)~+~0.00018~\mathrm{forest}(u)^2}$ 
</center>
</br>

### Model Validation 

```{r}
#Run the quadrat test
quadrat.test(fit, nx = 4, ny = 4)

```
This has small p value, suggesting significant deviation from our model's prediction.  Room for further improvement is therefore expected, but it does not provide hint for how to achieve any improvement.


### PPP Residuals

```{r}
#Calculate the residuals
res <- residuals(fit)

#Visualise
plot(res,
     cols = "transparent",
     main="Residuals Plots")

```
From the plot, it's observed that :

- A clear pattern is detected : Majority of the residual plots are in the "high residuals region"
- The residuals are small in magnitude (e^-8).  
- The negative residual values suggest over-prediction.
- there is room for improvement for the model


## Higher Order Polynomial Fitting with Spline and Validation
As the above analysis indicated a room for improvement, we will finally try to add higher-order polynomials with the spline packages.
```{r}
library(splines)

#Fit the PPP model
fit_smooth <- ppm(asc_data_ppp ~ bs(Elevation,7) + bs(Forest, 3), data = BC, use.gam = TRUE)

fit_smooth

```
```{r}
#Calculate the partial residuals as a function of elevation
par_res_elev <- parres(fit_smooth, "Elevation")

#Calculate the relative intensity as a function of gradient
par_res_forest <- parres(fit_smooth, "Forest")

#Side by side plotting
par(mfrow = c(1,2))
plot(par_res_elev,
     legend = FALSE,
     lwd = 2,
     main = "",
     xlab = "Elevation")
plot(par_res_forest,
     legend = FALSE,
     lwd = 2,
     main = "",
     xlab = "Forest")

```
```{r}
#AIC values
AIC(fit); AIC(fit_smooth)

#Delta AIC
AIC(fit) - AIC(fit_smooth)

#Likelihood ratio test
anova(fit, fit_smooth, test = "LRT")
```

All these suggest that this complex models provides a better fit to the data.  Let's finally visualize the predictions as before.

```{r}
#Plot the model predictions
plot(fit_smooth,
     se = FALSE,
     superimpose = FALSE,
     main = "Estimated Fungi intensity")

#Overlay the ocations
plot(asc_data_ppp,
     pch = 16,
     cex = 0.6,
     cols = "white",
     add = TRUE)
plot(asc_data_ppp,
     pch = 16,
     cex = 0.5,
     cols = "black",
     add = TRUE)

```
From this visualisation, the following is observed :

- Although the model is not yet perfect, it is progressively having improvement after rounds of variables selection process.  
- Considering the fact that we are predicting the locations of one species of fungi in a biodiverse continent based only on Elevation and Forest, and have no information on all of the many other factors that would significantly influence fungi growth (e.g. humidity, moisture level, temperature, pH value, oxygen content, etc. )

# Results :

# Discussion:   
Provide a brief summary of your findings. Length: ca. 1 page.
```{r}
```
# References:   
Include references to all necessary literature.
```{r}
```
```{r}
```
